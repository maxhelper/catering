<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Modal Form</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Literata:ital,wght@0,700;1,700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/imask"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
      }
      form {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 30px;
        background: #171717;
        border-radius: 30px;
      }
      .formbody {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
        align-self: stretch;
      }
      .date-time-row {
        display: flex;
        gap: 20px;
        width: 100%;
      }
      .date-time-row input {
        width: 100%;
      }
      input,
      textarea {
        display: flex;
        padding: 20px;
        align-items: center;
        gap: 10px;
        align-self: stretch;
        border-radius: 16px;
        background: #222;
        color: #fff;
        font-family: Inter;
        font-size: 16px;
        font-style: normal;
        font-weight: 500;
        line-height: 140%;
        letter-spacing: -0.32px;
        border: none;
        outline: none;
      }
      button {
        display: flex;
        padding: 26px 54px;
        justify-content: center;
        align-items: center;
        align-self: stretch;
        border-radius: 16px;
        background: #feffc5;
        color: #222;
        font-family: Inter;
        font-size: 20px;
        font-style: normal;
        font-weight: 600;
        line-height: 120%;
        letter-spacing: -0.4px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      button:hover {
        opacity: 0.6;
      }
      textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
      }
      @media (max-width: 400px) {
        form {
          border-radius: 20px;
        }
        .formbody {
          gap: 8px;
        }
        input,
        textarea {
          height: 48px;
          border-radius: 20px;
        }
        textarea {
          height: auto;
          min-height: 100px;
        }
        button {
          font-size: 16px;
          padding: 16px 32px;
          border-radius: 12px;
        }
        .date-time-row {
          flex-direction: column;
          gap: 8px;
        }
      }
    </style>
  </head>
  <body>
    <form id="main-form">
      <div class="formbody">
        <input id="name" type="text" placeholder="–ò–º—è" required /><input
          id="phone"
          type="tel"
          placeholder="+7 (___) ___-__-__"
          required
        /><input id="guests" type="text" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫" />
        <div class="date-time-row">
          <input id="date" type="text" placeholder="–î–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" /><input
            id="time"
            type="text"
            placeholder="–í—Ä–µ–º—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"
          />
        </div>
        <input id="address" type="text" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" /><input
          id="comments"
          type="text"
          placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É"
        /><textarea name="Cart" id="cart" style="display: none"></textarea>
      </div>
      <button type="submit" id="submit-btn">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        IMask(document.getElementById("phone"), {
          mask: "+{7} (000) 000-00-00",
          lazy: !1,
          overwrite: !0,
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω—ã –≤ textarea
        const updateCartData = () => {
          console.log('üìù Updating cart data in form...');
          
          try {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
            const cartManager = window.parent.cartManager;
            if (!cartManager) {
              console.log('‚ö†Ô∏è Cart manager not found in parent window');
              return;
            }
            
            const cart = cartManager.cart;
            const cartData = [];
            let totalSum = 0;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            Object.entries(cart).forEach(([boxId, quantity]) => {
              // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
              const cartItem = window.parent.document.querySelector(`[data-cart-item-id="${boxId}"]`);
              if (cartItem) {
                const title = cartItem.querySelector('[data-framer-name="cart-box-title"] p')?.textContent || `Box ${boxId}`;
                const priceText = cartItem.querySelector('[data-framer-name="cart-box-price"] p')?.textContent || '';
                const price = parseInt(priceText.replace(/[^\d]/g, '')) || 0;
                const itemSum = price * quantity;
                
                cartData.push(`item: title:${title}, quantity:${quantity}, price:${price}, sum:${itemSum}`);
                totalSum += itemSum;
              }
            });
            
            cartData.push(`total:${totalSum}`);
            
            const cartText = cartData.join('\n');
            const cartTextarea = document.getElementById('cart');
            if (cartTextarea) {
              cartTextarea.value = cartText;
              console.log('‚úÖ Cart data updated in form:', cartText);
            }
            
          } catch (error) {
            console.error('‚ùå Error updating cart data:', error);
          }
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateCartData();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        setInterval(updateCartData, 2000);
        
        const formatCartData = (e) => {
            if (!e) return "";

            try {
              const lines = e.trim().split("\n");
              const items = [];
              let total = "";

              for (const line of lines) {
                const trimmedLine = line.trim();

                if (trimmedLine.startsWith("total:")) {
                  total = trimmedLine.split("total:")[1].trim().split(".")[0];
                  continue;
                }

                if (!trimmedLine || !trimmedLine.startsWith("item:")) continue;

                const parts = trimmedLine.split(",").map((p) => p.trim());
                const title =
                  parts
                    .find((p) => p.includes("title:"))
                    ?.split("title:")[1]
                    ?.trim() || "";
                const quantity =
                  parts
                    .find((p) => p.includes("quantity:"))
                    ?.split("quantity:")[1]
                    ?.trim() || "";
                const price =
                  parts
                    .find((p) => p.includes("price:"))
                    ?.split("price:")[1]
                    ?.trim() || "";

                if (title && quantity && price) {
                  const item = `${title} - ${quantity}—à—Ç x ${price}‚ÇΩ`;
                  items.push(item);
                }
              }

              const result = `\n\n–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n${items.join(
                "\n"
              )}\n\n–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
              return result;
            } catch (err) {
              return e;
            }
          },
          e = document.getElementById("main-form"),
          t = document.getElementById("submit-btn");
        e.addEventListener("submit", async (n) => {
          n.preventDefault();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
          updateCartData();
          
          const a = document.getElementById("name").value.trim(),
            o = document.getElementById("phone").value.replace(/\D/g, ""),
            d = document.getElementById("guests").value.trim(),
            m = document.getElementById("date").value.trim(),
            l = document.getElementById("time").value.trim(),
            i = document.getElementById("address").value.trim(),
            s = document.getElementById("comments").value.trim(),
            r = document.getElementById("cart").value || "",
            c = new URLSearchParams({
              "FIELDS[NAME]": a,
              "FIELDS[PHONE][0][VALUE]": "+" + o,
              "FIELDS[PHONE][0][VALUE_TYPE]": "WORK",
              "FIELDS[TITLE]": "–ó–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞: –∫–æ—Ä–∑–∏–Ω–∞",
              "FIELDS[COMMENTS]": `–ì–æ—Å—Ç–µ–π: ${d || "-"}\n–î–∞—Ç–∞: ${
                m || "-"
              }\n–í—Ä–µ–º—è: ${l || "-"}\n–ê–¥—Ä–µ—Å: ${i || "-"}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${
                s || "-"
              }${formatCartData(r)}\n\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${window.location.href}`,
            });
          (t.disabled = !0), (t.textContent = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
          try {
            const n = await fetch(
                "https://mpcatering.bitrix24.ru/rest/33/y2inyitkzbcl4l56/crm.lead.add.json",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: c.toString(),
                }
              ),
              a = await n.json();
            if (a.result) {
              e.reset();
              t.textContent = "–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É";
              t.disabled = !1;
              
              // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
              if (window.parent.cartManager) {
                window.parent.cartManager.clearCart();
                console.log('üßπ Cart cleared after successful form submission');
              }
            } else {
              t.textContent = "–û—à–∏–±–∫–∞";
              t.disabled = !1;
            }
          } catch (n) {
            (t.textContent = "–û—à–∏–±–∫–∞"), (t.disabled = !1);
          }
        });
      });
    </script>
  </body>
</html>
